# PoToken Implementation for Bot Detection Bypass

## Overview

This document describes the implementation of PoToken (Proof of Origin Token) functionality in SimiluBot to handle YouTube's bot detection system. The implementation provides automatic fallback mechanisms and configuration options to ensure music functionality continues working even when Google's bot detection is triggered.

## What is PoToken?

PoToken is a parameter that YouTube requires to be sent with video playback requests from some clients. Without it, format URL requests may return HTTP error 403, bot detection errors, or result in IP address blocking. The token is generated by BotGuard (Web) / DroidGuard (Android) to attest that requests are coming from a genuine client.

## Implementation Features

### 1. **Automatic Bot Detection Handling**
- Detects bot detection errors automatically
- Implements fallback chain for seamless operation
- Logs detailed information for debugging

### 2. **Multiple PoToken Methods**
- **Automatic Generation**: Uses nodejs to generate PoToken automatically
- **Manual Configuration**: Allows manual PoToken and visitorData input
- **Interactive Prompting**: Falls back to interactive input when needed

### 3. **Fallback Chain**
When bot detection occurs, the system tries these methods in order:
1. Switch to WEB client with auto PoToken generation (if nodejs available)
2. Use manual PoToken configuration (if configured)
3. Prompt for manual PoToken input (if enabled)

### 4. **Backward Compatibility**
- Works without any configuration changes
- Existing functionality remains unchanged
- Optional PoToken features can be enabled as needed

## Configuration

### Basic Configuration

Add the following to your `config/config.yaml` under the `music` section:

```yaml
music:
  # ... existing music configuration ...
  
  # YouTube PoToken Configuration (Bot Detection Bypass)
  youtube:
    # Automatic bot detection handling
    auto_fallback_on_bot_detection: true  # Automatically try fallback methods when bot detection occurs
    
    # PoToken settings
    potoken:
      enabled: false  # Set to true to enable PoToken usage
      auto_generate: true  # Automatically generate PoToken using nodejs (requires nodejs installed)
      client: "WEB"  # Client type for PoToken: "WEB", "WEB_EMBED", "ANDROID", "MWEB"
      
      # Manual PoToken configuration (used when auto_generate is false)
      manual:
        visitor_data: ""  # Manual visitorData (leave empty to prompt)
        po_token: ""  # Manual PoToken (leave empty to prompt)
        
      # PoToken caching
      cache_enabled: true  # Cache PoToken and visitorData for reuse
      
    # Fallback configuration
    fallback:
      use_web_client: true  # Try WEB client as first fallback
      prompt_for_manual_potoken: false  # Prompt for manual PoToken as last resort (not recommended for bots)
```

### Configuration Options Explained

#### Auto Fallback
- `auto_fallback_on_bot_detection`: When enabled, automatically tries fallback methods when bot detection is encountered
- Recommended: `true` for seamless operation

#### PoToken Settings
- `enabled`: Master switch for PoToken functionality
- `auto_generate`: Use nodejs to automatically generate PoToken (requires nodejs installation)
- `client`: YouTube client type to use with PoToken
- `cache_enabled`: Cache generated tokens for reuse (improves performance)

#### Manual Configuration
- `visitor_data`: Manually obtained visitorData from browser
- `po_token`: Manually obtained PoToken from browser
- Leave empty to use interactive prompting

#### Fallback Options
- `use_web_client`: Try WEB client as first fallback method
- `prompt_for_manual_potoken`: Enable interactive prompting (not recommended for Discord bots)

## Usage Scenarios

### Scenario 1: Basic Setup (Recommended)
```yaml
music:
  youtube:
    auto_fallback_on_bot_detection: true
    potoken:
      enabled: false  # Start with disabled, enable if needed
    fallback:
      use_web_client: true
```

### Scenario 2: Auto PoToken with nodejs
```yaml
music:
  youtube:
    auto_fallback_on_bot_detection: true
    potoken:
      enabled: true
      auto_generate: true
      client: "WEB"
    fallback:
      use_web_client: true
```

### Scenario 3: Manual PoToken Configuration
```yaml
music:
  youtube:
    auto_fallback_on_bot_detection: true
    potoken:
      enabled: true
      auto_generate: false
      manual:
        visitor_data: "your_visitor_data_here"
        po_token: "your_po_token_here"
    fallback:
      use_web_client: true
```

## Error Handling

### Bot Detection Errors
The system automatically detects these error patterns:
- "detected as a bot"
- "Use `use_po_token=True`"
- "switch to WEB client"
- "bot detection"
- "HTTP Error 403"

### Logging
Enhanced logging provides detailed information:
```
INFO - PoToken functionality enabled
INFO - Auto PoToken generation enabled
WARNING - Bot detection detected, trying fallback method 2
INFO - Successfully bypassed bot detection using attempt 2
ERROR - Bot detection error - consider enabling PoToken functionality
```

## Requirements

### For Auto PoToken Generation
- **nodejs**: Required for automatic PoToken generation
- Install from: https://nodejs.org/en
- Must be available in system PATH

### For Manual PoToken
- Browser access to YouTube
- Developer tools knowledge for extracting tokens

## Troubleshooting

### Common Issues

1. **"Bot detection error" messages**
   - Enable PoToken functionality: `potoken.enabled: true`
   - Ensure nodejs is installed for auto-generation
   - Check fallback configuration

2. **"Failed to create YouTube object"**
   - Verify internet connection
   - Check if YouTube is accessible
   - Try enabling different fallback methods

3. **PoToken generation fails**
   - Ensure nodejs is installed and in PATH
   - Try manual PoToken configuration
   - Check system permissions

### Debug Mode
Enable debug logging to see detailed PoToken operations:
```yaml
logging:
  level: "DEBUG"
```

## Performance Impact

- **Auto PoToken Generation**: Adds ~2 seconds per request (varies by hardware/connection)
- **Manual PoToken**: Minimal performance impact
- **Caching**: Reduces subsequent request overhead
- **Clients without PoToken**: No performance impact

## Security Considerations

- PoToken and visitorData are cached locally
- No sensitive information is logged
- Manual tokens should be kept secure
- Regular token refresh may be required

## Migration Guide

### From Previous Versions
1. Update configuration file with new PoToken section
2. No code changes required
3. Test with `auto_fallback_on_bot_detection: true`
4. Enable PoToken if bot detection occurs

### Enabling PoToken
1. Set `potoken.enabled: true`
2. Install nodejs for auto-generation (recommended)
3. Or configure manual tokens
4. Monitor logs for successful operation

## Support

For issues related to PoToken functionality:
1. Check logs for detailed error messages
2. Verify configuration syntax
3. Test with different fallback methods
4. Refer to pytubefix documentation for advanced usage
