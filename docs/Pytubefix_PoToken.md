# Added PoToken support

*Posted by @felipeucelli*

## Added PoToken support

The proof of origin (PO) token is a parameter that YouTube requires to be sent with video playback requests from some clients. Without it, format URL requests from affected customers may return HTTP [error 403](https://github.com/JuanBindez/pytubefix/issues/195), [error with bot detection](https://github.com/JuanBindez/pytubefix/pull/170), or result in your [account or IP address being blocked](https://github.com/JuanBindez/pytubefix/issues/119).

This token is generated by BotGuard (Web) / DroidGuard (Android) to attest the requests are coming from a genuine client.

The generation of PoToken by botguard involves several obfuscated functions created dynamically, which can have misleading ramifications, and is almost impossible to replicate in Python.

## Using PoToken

As it is not an easy task to generate the PoToken in Python, we will have to resort to external resources

### Automatic PO Token generation with nodejs

From version 8.12 onwards, pytubefix has the ability to generate a PoToken automatically, all you need to have is [nodejs](https://nodejs.org/en) installed on your machine and change the client to some poToken client, for example the WEB client:

```python
from pytubefix import YouTube

url = input("url >")

yt = YouTube(url, 'WEB')
print(yt.title)

ys = yt.streams.get_highest_resolution()
ys.download()
```

See the full patch note: [https://github.com/JuanBindez/pytubefix/pull/408](https://github.com/JuanBindez/pytubefix/pull/408)

If you don't have nodejs or can't install it, don't worry, it's possible to manually pass a PoToken.

### Manually acquiring a PO Token from a browser for use when logged out

This process involves manually obtaining a PO token generated from YouTube in a web browser and then manually passing it to pytubefix via the `use_po_token=True` argument. Steps:

1. Open a browser and go to any video on YouTube Music or YouTube Embedded (e.g. https://www.youtube.com/embed/aqz-KE-bpKQ). Make sure you are not logged in to any account!

2. Open the developer console (F12), then go to the "Network" tab and filter by v1/player

3. Click the video to play and a player request will appear in the network tab

4. In the request payload JSON, find the PO Token at `serviceIntegrityDimensions.poToken` and save that value

5. In the request payload JSON, find the visitorData at `context.client.visitorData` and save that value

6. In the pytubefix code, pass the parameter `use_po_token=True`, to send the visitorData and PoToken:

We can also use some scripts that speed up this process, for example: [https://github.com/YunzheZJU/youtube-po-token-generator](https://github.com/YunzheZJU/youtube-po-token-generator) or any other script of your choice

After obtaining the PoToken and the linked visitorData, you can send them to pytubefix similar to the oauth method:
```python
from pytubefix import YouTube

url = input("url >")

yt = YouTube(url, use_po_token=True)
print(yt.title)

ys = yt.streams.get_highest_resolution()
ys.download()
```

This will ask the terminal to input visitorData and PoToken respectively.

You can also customize the function that inserts visitorData and PoToken, just pass it using `po_token_verifier`, similar to #190 

If `allow_oauth_cache` (we should change the name to allow_cache, but let's maintain compatibility) is True, the visitorData and PoToken will be cached and reused in the next requests **(They may expire)**.

## FAQ

### Detected as a bot even using PoToken

The main purpose of passing PO Token is to help prevent getting blocked (if on non-DC IP) and allow formats from web clients to work.

If you are being detected as a bot even after passing the PoToken, there are only two alternatives:

1. Log in with `use_oauth` (and risk getting your account banned)

2. Use a proxy to change your IP address.

If even after these attempts you continue to be detected, unfortunately there is nothing we can do.

### Clients affected with PoToken

Currently ANDROID, WEB_EMBED, MWEB and WEB clients need PoToken to obtain functional streams, otherwise only progressive streams in 360p will work.

As the PoToken generated by BotGuard "is easier to get", pytubefix will default to the WEB client when using `use_po_token=True`.

To use the affected clients, we have to send the visitorData and PoToken via the API and then add the PoToken to each stream with the query `pot` parameter.

### Observation

Although it is possible to use `use_po_token` together with `use_oauth`, it is not a good idea, as YouTube can track you more easily.

---
# Added poToken generation

*Posted by @felipeucelli*

# ATTENTION
This is experimental and requires [nodejs](https://nodejs.org/en) installed on the machine.

## Operation

This PR adds the ability for pytubefix to automatically generate the proof of origin token (PoToken) through `botGuard.js`

PoToken generation basically consists of invoking botGuard.js with nodejs and passing a visitorData as a parameter.

PoToken generation requires a node js environment, so we will need to have it on our machine. The `bot_guard.py` file is responsible for locating and calling nodejs within the code. 

Initially, we thought of adding the binary using the same technique that [imageio-ffmpeg](https://github.com/imageio/imageio-ffmpeg) used to install ffmpeg (perhaps we can do this in the future), then the existence of the binary will be checked within the `botGuard/binaries/` folder, if it is not found, it will be done an attempt to call it using the `node` environment variable, and if it still fails, pytubefix will skip generating the PoToken, warning the user and will continue executing the code.

Currently the clients that need PoToken to work correctly are: `WEB`, `WEB_EMBED` and `ANDROID` (I believe that soon all clients will need it), so pytubefix will check the requirement for each client and will invoke botGuard only if necessary.

If you prefer to manually pass the PoToken using `use_po_token=True`, don't worry, it will work perfectly. When passed manually, botGuard will not be invoked.

## FAQ

### Will pytubefix have dependencies?

I don't believe this is directly a dependency, as the library's operation will not be interrupted if nodejs is not installed.

This will make it easier for users who have servers and constantly need to manually generate new PoTokens to avoid being detected as a bot. And most of the servers already have nodejs installed, all they will need to do is change the client to `WEB`.

### Do I need to do any configuration in nodejs?

All you need to do is install nodejs and make sure to put it in your system path, pytubefix will automatically call it using the `node` environment variable.

### Will the library's performance be affected?

As is to be expected, WEB-based clients require the decryption of several parameters, and this reduces performance somewhat. As for the automatic generation of the PoToken, I particularly noticed an increase of just under 2 seconds (this may vary depending on the hardware and internet connection).

**Clients who do not need PoToken will not be affected.**

### I want to automatically generate PoToken but I can't install nodejs

You can simply download the binary corresponding to your system from the official [nodejs](https://nodejs.org/en/download) page and place it in the `pytubefix/botGuard/binaries/` folder. You may have to change the `bot_guard.py` file to recognize the binary, currently it only recognizes **Linux** and **Windows**.

### What do we have in botGuard.js? 

Basically we have [https://github.com/LuanRT/BgUtils](https://github.com/LuanRT/BgUtils) project modified to our needs and packaged with webpack.

## Changes

- Added automatic generation of PoToken.

- Changed the `require_po_token` of the `WEB_EMBED` client to `True`

- Added `botGuad.js` for PoToken generation

- Added `bot_guard.py` to wrap nodejs

- Changed bot detection error message, recommending the user to try to use the WEB client to automatically generate the PoToken

